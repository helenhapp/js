<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ловець Зірок</title>
    <link rel="icon" type="image/x-icon" href="./images/favicon.ico" />
    <style>
      :root {
        --bg: #0a1030;
        --panel: #0d1440;
        --panel-alt: #102159;
        --accent: #4fa7ff;
        --shadow-accent: rgba(79, 167, 255, 0.25);
        --text-main: #d6ecff;
        --title: #78c7ff;
        --title-glow: rgba(120, 199, 255, 0.6);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 10px;
        min-height: 100dvh;
        color: var(--text-main);
        font-family: Arial, sans-serif;
      }

      h1 {
        text-align: center;
        font-size: 35px;
        color: var(--title);
        text-shadow: 0 0 8px var(--title-glow);
        margin-bottom: 10px;
      }

      .instruction {
        font-size: 16px;
        margin-bottom: 10px;
        text-align: center;
      }

      #game-world {
        width: 95%;
        max-width: 800px;
        background: var(--panel);
        border: 2px solid var(--accent);
        border-radius: 6px;
        box-shadow: 0 0 20px var(--shadow-accent);
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
      }

      #player {
        position: absolute;
        image-rendering: pixelated;
        z-index: 10;
      }

      .star {
        position: absolute;
        width: 32px;
        height: 32px;
        font-size: 32px;
        text-align: center;
        line-height: 32px;
        pointer-events: none;
        user-select: none;
        z-index: 8;
      }

      .game-over {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        color: goldenrod;
        font-size: 28px;
        font-weight: 500;
        text-align: center;
        border-radius: 6px;
        display: none;
        z-index: 20;
      }

      .touch-controls {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .touch-row {
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      .touch-button {
        width: 55px;
        height: 55px;
        background: var(--panel-alt);
        color: var(--text-main);
        border: 2px outset var(--accent);
        border-radius: 6px;
        font-size: 24px;
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        box-shadow: 0 0 10px var(--shadow-accent);
        touch-action: none;
        transition: 0.2s ease;
      }

      .touch-button.pressed {
        transform: scale(0.9);
        background: var(--panel);
      }

      @media (max-width: 650px) {
        .touch-controls {
          display: flex;
        }
        .star {
          width: 20px;
          height: 20px;
          font-size: 20px;
          line-height: 20px;
        }
        .game-over {
          font-size: 22px;
        }
      }
    </style>
  </head>
  <body>
    <h1>Ловець Зірок</h1>
    <div class="instruction">
      Використовуйте клавіші або кнопки для руху. <br />Завдання: зібрати всі
      зірки.
    </div>

    <div id="game-world">
      <div id="player"></div>
      <div id="game-over" class="game-over">
        Ви зібрали всі зірки! <br />Гру завершено.
      </div>
    </div>

    <div class="touch-controls">
      <div class="touch-row">
        <div class="touch-button" data-dir="UP">↑</div>
      </div>
      <div class="touch-row">
        <div class="touch-button" data-dir="LEFT">←</div>
        <div class="touch-button" data-dir="DOWN">↓</div>
        <div class="touch-button" data-dir="RIGHT">→</div>
      </div>
    </div>

    <script>
      const FRAME_WIDTH = 32,
        FRAME_HEIGHT = 48,
        FRAME_COUNT = 8,
        ANIMATION_FPS = 10;
      const PLAYER_SPEED = 1.5,
        frameDuration = 1000 / ANIMATION_FPS;
      const SPRITE_SHEETS = {
        EAST: "./images/blue_walk_EAST-Sheet.png",
        WEST: "./images/blue_walk_WEST-Sheet.png",
      };
      const playerEl = document.getElementById("player");
      const gameWorldEl = document.getElementById("game-world");
      const gameOverEl = document.getElementById("game-over");

      const player = {
        x: 0,
        y: 0,
        direction: "EAST",
        isMoving: false,
        currentFrame: 0,
      };
      const keysPressed = {};
      let lastTimestamp = 0,
        animationTimer = 0,
        gameRunning = true;

      // --- Player scale ---
      function updatePlayerScale() {
        const scaleW = gameWorldEl.clientWidth / 800;
        const scaleH = gameWorldEl.clientHeight / 600;
        let scale = Math.min(scaleW, scaleH) * 2.5;
        if (window.innerWidth <= 650) scale *= 1.3;
        playerEl.style.width = FRAME_WIDTH * scale + "px";
        playerEl.style.height = FRAME_HEIGHT * scale + "px";
        playerEl.style.backgroundSize =
          FRAME_WIDTH * FRAME_COUNT * scale +
          "px " +
          FRAME_HEIGHT * scale +
          "px";
        playerEl.dataset.scale = scale;
      }
      window.addEventListener("resize", updatePlayerScale);

      // --- Controls ---
      document.addEventListener("keydown", (e) => {
        const key = e.key.toUpperCase();
        if (["ARROWUP", "ARROWDOWN", "ARROWLEFT", "ARROWRIGHT"].includes(key)) {
          keysPressed[key] = true;
          player.isMoving = true;
          e.preventDefault();
        }
      });
      document.addEventListener("keyup", (e) => {
        const key = e.key.toUpperCase();
        if (["ARROWUP", "ARROWDOWN", "ARROWLEFT", "ARROWRIGHT"].includes(key)) {
          keysPressed[key] = false;
          player.isMoving =
            keysPressed["ARROWUP"] ||
            keysPressed["ARROWDOWN"] ||
            keysPressed["ARROWLEFT"] ||
            keysPressed["ARROWRIGHT"];
        }
      });

      document.querySelectorAll(".touch-button").forEach((btn) => {
        btn.addEventListener("touchstart", (e) => {
          btn.classList.add("pressed");
          const dir = btn.dataset.dir.toUpperCase();
          keysPressed["ARROW" + dir] = true;
          player.isMoving = true;
          e.preventDefault();
        });
        btn.addEventListener("touchend", (e) => {
          btn.classList.remove("pressed");
          const dir = btn.dataset.dir.toUpperCase();
          keysPressed["ARROW" + dir] = false;
          player.isMoving =
            keysPressed["ARROWUP"] ||
            keysPressed["ARROWDOWN"] ||
            keysPressed["ARROWLEFT"] ||
            keysPressed["ARROWRIGHT"];
        });
      });

      // --- Movement ---
      function updatePosition() {
        if (!gameRunning) return;
        let dx = 0,
          dy = 0;
        const scale = parseFloat(playerEl.dataset.scale || 2.5);
        const displayW = FRAME_WIDTH * scale,
          displayH = FRAME_HEIGHT * scale;
        if (keysPressed["ARROWLEFT"]) {
          dx -= PLAYER_SPEED;
          player.direction = "WEST";
        }
        if (keysPressed["ARROWRIGHT"]) {
          dx += PLAYER_SPEED;
          player.direction = "EAST";
        }
        if (keysPressed["ARROWUP"]) dy -= PLAYER_SPEED;
        if (keysPressed["ARROWDOWN"]) dy += PLAYER_SPEED;

        const halfW = displayW / 2,
          halfH = displayH / 2;
        player.x = Math.min(
          Math.max(player.x + dx, halfW),
          gameWorldEl.clientWidth - halfW
        );
        player.y = Math.min(
          Math.max(player.y + dy, halfH),
          gameWorldEl.clientHeight - halfH
        );
      }

      // --- Animation ---
      function updateAnimation(timestamp) {
        if (!gameRunning) return;
        const deltaTime = timestamp - lastTimestamp;
        lastTimestamp = timestamp;
        if (player.isMoving) {
          animationTimer += deltaTime;
          if (animationTimer >= frameDuration) {
            player.currentFrame = (player.currentFrame + 1) % FRAME_COUNT;
            animationTimer %= frameDuration;
          }
        } else player.currentFrame = 0;
        playerEl.style.backgroundImage = `url(${
          player.direction === "WEST" ? SPRITE_SHEETS.WEST : SPRITE_SHEETS.EAST
        })`;
        const scale = parseFloat(playerEl.dataset.scale || 2.5);
        const bgX = player.currentFrame * FRAME_WIDTH;
        playerEl.style.backgroundPosition = `-${bgX * scale}px 0`;
        playerEl.style.transform = `translate(${
          player.x - (FRAME_WIDTH * scale) / 2
        }px, ${player.y - (FRAME_HEIGHT * scale) / 2}px)`;
      }

      // --- Night sky background ---
      const STAR_BG_COUNT = 100;
      function generateBackgroundDots() {
        for (let i = 0; i < STAR_BG_COUNT; i++) {
          const dot = document.createElement("div");
          dot.style.position = "absolute";
          dot.style.width = dot.style.height = "2px";
          dot.style.borderRadius = "50%";
          dot.style.background = Math.random() < 0.5 ? "#fff" : "#ffec99";
          dot.style.left = Math.random() * 100 + "%";
          dot.style.top = Math.random() * 100 + "%";
          dot.style.pointerEvents = "none";
          dot.style.zIndex = "1";
          gameWorldEl.appendChild(dot);
        }
      }

      // --- Stars ---
      const stars = [];
      const STAR_COUNT = 5;
      function spawnStars() {
        // Remove old stars
        stars.forEach((s) => s.remove());
        stars.length = 0;

        const scale = parseFloat(playerEl.dataset.scale || 2.5);
        const displayW = FRAME_WIDTH * scale;
        const displayH = FRAME_HEIGHT * scale;

        for (let i = 0; i < STAR_COUNT; i++) {
          const star = document.createElement("div");
          star.classList.add("star");
          star.textContent = "⭐";

          let x, y;
          do {
            x = Math.random() * (gameWorldEl.clientWidth - 32);
            y = Math.random() * (gameWorldEl.clientHeight - 32);
          } while (
            Math.abs(x + 16 - player.x) < 100 &&
            Math.abs(y + 16 - player.y) < 100
          ); // keep stars away from player

          star.style.left = x + "px";
          star.style.top = y + "px";
          gameWorldEl.appendChild(star);
          stars.push(star);
        }
      }

      // --- Collect stars ---
      function checkStars() {
        if (!gameRunning) return;
        const scale = parseFloat(playerEl.dataset.scale || 2.5);
        const playerRect = {
          x: player.x - (FRAME_WIDTH * scale) / 2,
          y: player.y - (FRAME_HEIGHT * scale) / 2,
          w: FRAME_WIDTH * scale,
          h: FRAME_HEIGHT * scale,
        };
        for (let i = stars.length - 1; i >= 0; i--) {
          const s = stars[i];
          const starRect = s.getBoundingClientRect();
          const worldRect = gameWorldEl.getBoundingClientRect();
          const sx = starRect.left - worldRect.left;
          const sy = starRect.top - worldRect.top;
          const sw = starRect.width,
            sh = starRect.height;
          if (
            playerRect.x < sx + sw &&
            playerRect.x + playerRect.w > sx &&
            playerRect.y < sy + sh &&
            playerRect.y + playerRect.h > sy
          ) {
            s.remove();
            stars.splice(i, 1);
            if (stars.length === 0) {
              gameOverEl.style.display = "flex";
              gameRunning = false;
            }
          }
        }
      }

      function gameLoop(timestamp) {
        if (gameRunning) {
          updatePosition();
          updateAnimation(timestamp);
          checkStars();
          requestAnimationFrame(gameLoop);
        }
      }

      window.onload = () => {
        updatePlayerScale();
        player.x = gameWorldEl.clientWidth / 2;
        player.y = gameWorldEl.clientHeight / 2;
        generateBackgroundDots();
        spawnStars();
        gameLoop(0);
      };

      function resizeGameWorld() {
        const h1 = document.querySelector("h1");
        const instruction = document.querySelector(".instruction");
        const buttonsHeight =
          document.querySelector(".touch-controls")?.offsetHeight || 0;
        const padding = 20; // body padding

        // Compute available height for game-world
        const availableHeight =
          window.innerHeight -
          h1.offsetHeight -
          instruction.offsetHeight -
          buttonsHeight -
          padding -
          100;

        gameWorldEl.style.height = availableHeight + "px";

        updatePlayerScale(); // scale player after setting height

        // Optional: Reposition player inside the visible game-world
        player.x = Math.min(
          Math.max(player.x, FRAME_WIDTH / 2),
          gameWorldEl.clientWidth - FRAME_WIDTH / 2
        );
        player.y = Math.min(
          Math.max(player.y, FRAME_HEIGHT / 2),
          gameWorldEl.clientHeight - FRAME_HEIGHT / 2
        );
      }

      // Call on load and resize
      window.addEventListener("load", () => {
        resizeGameWorld();
        player.x = gameWorldEl.clientWidth / 2;
        player.y = gameWorldEl.clientHeight / 2;
        generateBackgroundDots();
        spawnStars(); // stars now spawn in correct visible area
        gameLoop(0);
      });

      window.addEventListener("resize", () => {
        resizeGameWorld();
        spawnStars(); // optional: respawn stars on resize to fit screen
      });
    </script>
  </body>
</html>
